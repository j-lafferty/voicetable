<!doctype html>
<html>
  <head>
    <meta charset="utf-8">
    <title>{{ project.name }}</title>
    <style>
      body { font-family: system-ui, sans-serif; }
      table { border-collapse: collapse; width: 100%; }
      th, td { border: 1px solid #ddd; padding: 6px 8px; vertical-align: top; }
      thead th { position: sticky; top: 0; background: #f5f5f5; }
      .toolbar { display:flex; gap:12px; margin: 10px 0; align-items: center; }
      input, select { padding: 6px; }
    </style>
  </head>
  <body>
    <h1>{{ project.name }}</h1>

    <div class="toolbar">
      <input id="search" type="text" placeholder="Search…" />
      <label>Page size:
        <select id="pagesize">
          <option>50</option><option selected>100</option><option>250</option><option>500</option>
        </select>
      </label>
      <span id="meta"></span>
    </div>

    <table id="grid">
      <thead>
        <tr>
          <th>row_id</th>
          {% for col in columns %}
            <th>{{ col }}</th>
          {% endfor %}
          <th>audio</th>
        </tr>
      </thead>
      <tbody></tbody>
    </table>

    <div class="toolbar">
      <button id="prev">Prev</button>
      <button id="next">Next</button>
    </div>

    {{ project.column_headers|json_script:"project-columns" }}

    <script>
        const slug = "{{ project.slug }}";
        const projectColumns = JSON.parse(
            document.getElementById("project-columns").textContent
        );
        let page = 1;
      
        const tbody = document.querySelector("#grid tbody");
        const meta = document.getElementById("meta");
        const searchEl = document.getElementById("search");
        const pagesizeEl = document.getElementById("pagesize");
      
        async function load() {
          const params = new URLSearchParams({
            page, page_size: pagesizeEl.value,
            search: searchEl.value.trim()
          });
          const res = await fetch(`/api/project/${slug}/rows?` + params.toString(), {credentials:'same-origin'});
          if (!res.ok) { alert("Failed to load"); return; }
          const data = await res.json();
          render(data);
        }
      
        function render(data) {
          tbody.innerHTML = "";
          for (const row of data.rows) {
            const tr = document.createElement("tr");
            const tdId = document.createElement("td"); tdId.textContent = row.row_id; tr.appendChild(tdId);
            for (const col of projectColumns) {
              const td = document.createElement("td"); td.textContent = row.data[col] ?? ""; tr.appendChild(td);
            }
            const tdAudio = document.createElement("td");
            const langs = Object.keys(row.audio || {});
            if (langs.length) {
              for (const lang of langs) {
                const audio = document.createElement("audio");
                audio.controls = true;
                audio.src = row.audio[lang];
                audio.preload = "none";
                tdAudio.appendChild(document.createTextNode(lang + ": "));
                tdAudio.appendChild(audio);
                tdAudio.appendChild(document.createElement("br"));
              }
            } else {
              tdAudio.textContent = "—";
            }
            tr.appendChild(tdAudio);
            tbody.appendChild(tr);
          }
          meta.textContent = `Page ${data.page} of ${data.pages} • ${data.total} rows`;
        }
      
        document.getElementById("prev").onclick = () => { if (page > 1) { page--; load(); } };
        document.getElementById("next").onclick = () => { page++; load(); };
        searchEl.onchange = () => { page = 1; load(); };
        pagesizeEl.onchange = () => { page = 1; load(); };
      
        load();
    </script>
  </body>
</html>
